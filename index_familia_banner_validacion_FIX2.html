
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>El Gran Bingo de la T√≠a Finin</title>

  <!-- Tipograf√≠as Navide√±as y Modernas -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Paleta Premium Navide√±a */
      --bg-gradient: radial-gradient(circle at 50% 30%, #a4161a, #660708);
      --gold: #ffb703;
      --gold-shine: #ffd166;
      --green: #2d6a4f;
      --white: #ffffff;
      --glass: rgba(255, 255, 255, 0.15);
      --glass-border: rgba(255, 255, 255, 0.3);
      --shadow-hard: 0 10px 25px rgba(0,0,0,0.5);

      --radius: 16px;
    }

    /* --- Base --- */
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      overflow: hidden;
      position: fixed;
      overscroll-behavior: none;
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: var(--white);
    }

    /* Efecto Nieve CSS */
    .snow, .snow:after, .snow:before {
      content: ""; position: absolute; top: -650px; left: 0; right: 0; bottom: 0;
      background-image:
        radial-gradient(4px 4px at 100px 50px, #fff , transparent),
        radial-gradient(6px 6px at 200px 150px, #fff, transparent),
        radial-gradient(3px 3px at 300px 250px, #fff, transparent);
      background-size: 650px 650px;
      animation: snowAnim 10s linear infinite; opacity: 0.3; pointer-events: none; z-index: 0;
    }
    .snow:after { margin-left: -250px; opacity: 0.5; animation-duration: 15s; animation-direction: reverse; filter: blur(2px);}
    .snow:before { margin-left: -150px; opacity: 0.7; animation-duration: 20s; filter: blur(1px);}
    @keyframes snowAnim { from { transform: translateY(0); } to { transform: translateY(650px); } }

    /* --- Canvas Confeti --- */
    #confetti-canvas {
      position: fixed; inset: 0; pointer-events: none; z-index: 100;
    }

    /* --- Layout App --- */
    .app {
      position: relative; z-index: 10; height: 100%; width: 100%;
      display: flex; flex-direction: column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* --- Header --- */
    header {
      padding: 10px 20px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      flex-shrink: 0;
      gap: 10px;
    }
    .logo {
      font-family: 'Mountains of Christmas', cursive; font-size: 28px;
      color: var(--gold); text-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1;
      white-space: nowrap;
    }
    .status-badge {
      font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
      padding: 5px 12px; border-radius: 50px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold);
      white-space: nowrap;
    }

    /* Bot√≥n Micr√≥fono Nuevo */
    .header-controls { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }

    .mic-btn {
      background: rgba(0,0,0,0.3);
      width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
      font-size: 20px; display: flex; align-items: center; justify-content: center;
      border: 1px solid transparent; color: white;
      transition: all 0.3s;
    }
    .mic-btn.listening {
      background: #d00000;
      border-color: #ffb703;
      box-shadow: 0 0 15px #d00000;
      animation: micPulse 1.5s infinite;
    }
    @keyframes micPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(208, 0, 0, 0.7); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(208, 0, 0, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(208, 0, 0, 0); }
    }

    /* --- Main Container --- */
    main {
      flex: 1; display: flex; overflow: hidden; position: relative;
    }

    /* --- Componentes Visuales --- */

    /* 1. BOMBO / HERO */
    .hero-panel {
      position: relative;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-right: 1px solid var(--glass-border);
      z-index: 20;
    }

    .ball-wrapper {
      position: relative;
      width: 140px; height: 140px;
      margin-bottom: 10px;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
    }

    .bingo-ball {
      width: 100%; height: 100%; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #ffffff 0%, #ffdfba 10%, #d00000 50%, #5a0000 100%);
      display: grid; place-items: center;
      font-size: 68px; font-weight: 900; color: #5a0000;
      position: relative;
      transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .bingo-ball.pop { transform: scale(1.05); }
    /* Brillo bola */
    .bingo-ball::after {
      content: ''; position: absolute; top: 10%; left: 15%; width: 25%; height: 15%;
      border-radius: 50%; background: rgba(255,255,255,0.6); transform: rotate(-45deg);
    }

    .hero-text { text-align: center; max-width: 300px; }
    .fun-phrase {
      font-family: 'Mountains of Christmas', cursive; font-size: 26px;
      color: var(--gold-shine); line-height: 1.1; margin-bottom: 5px; min-height: 60px;
      text-shadow: 0 2px 2px rgba(0,0,0,0.8);
    }
    .balls-left { font-size: 13px; opacity: 0.7; font-weight: bold; letter-spacing: 1px; }

    /* 2. TABLERO (GRID) */
    .grid-panel {
      flex: 1; background: #f0f0f0;
      display: flex; flex-direction: column;
      padding: 10px;
      border-radius: 20px 20px 0 0; /* Redondeado en m√≥vil */
      box-shadow: inset 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .grid-header {
      text-align: center; color: #555; font-weight: 900;
      font-size: 14px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .tiny-pill{
      font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;
      padding: 4px 10px; border-radius: 999px;
      background: rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.12);
      color: #444;
    }

    .grid-container {
      flex: 1; overflow-y: auto; padding-bottom: 80px; /* Espacio botones m√≥vil */
      -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
    }

    .grid {
      display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px;
    }

    .cell {
      aspect-ratio: 1;
      background: #fff; border-radius: 8px;
      box-shadow: 0 2px 0 #ccc;
      display: flex; align-items: center; justify-content: center;
      font-size: clamp(14px, 4vw, 24px);
      font-weight: 900; color: #333;
      user-select: none; transition: transform 0.2s;
    }

    .cell.marked {
      background: #d00000; color: #fff;
      box-shadow: inset 0 3px 5px rgba(0,0,0,0.3);
      border: 2px solid #8a1c28;
    }
    .cell.last {
      background: var(--gold); color: #000;
      animation: pulse 1s infinite;
      z-index: 2; transform: scale(1.1);
      box-shadow: 0 0 15px var(--gold);
      border: 2px solid #fff;
    }
    @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.15);} 100%{transform:scale(1);} }

    /* --- Cart√≥n Jugador (3x9) --- */
    .card-grid{
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 6px;
      padding: 8px;
    }
    .cell.card{
      border-radius: 10px;
      font-size: clamp(18px, 6vw, 34px);
      box-shadow: 0 2px 0 #cfcfcf;
      border: 2px solid rgba(0,0,0,0.05);
    }
    .cell.empty{
      background: rgba(255,255,255,0.25);
      box-shadow: none;
      border: 2px dashed rgba(0,0,0,0.08);
      color: transparent;
    }

    /* 3. CONTROLES */
    .controls-wrapper {
      padding: 10px; display: flex; gap: 10px; flex-direction: column;
    }
    /* Estilos Botones Premium */
    button {
      border: none; border-radius: 12px; cursor: pointer;
      font-family: 'Poppins', sans-serif; font-weight: 800; text-transform: uppercase;
      transition: all 0.1s; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center; text-align: center;
      box-shadow: 0 5px 0 rgba(0,0,0,0.2);
    }
    button:active { transform: translateY(4px); box-shadow: none; }
    button:disabled { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; }

    /* Efecto brillo botones */
    button::before {
      content: ''; position: absolute; top:0; left:0; width:100%; height:50%;
      background: rgba(255,255,255,0.15); pointer-events: none;
    }

    .btn-play { height: 60px; font-size: 20px; background: var(--gold); color: #4a3b00; text-shadow: 0 1px 0 rgba(255,255,255,0.4); }
    .btn-action { height: 50px; font-size: 14px; background: rgba(255,255,255,0.9); color: #333; }
    .btn-bingo { flex: 1; height: 50px; background: #d90429; color: white; font-size: 16px; }
    .btn-linea { flex: 1; height: 50px; background: var(--green); color: white; font-size: 16px; }

    .btn-row { display: flex; gap: 10px; width: 100%; }

    /* --- Responsive Layouts --- */

    /* Portrait (M√≥vil Vertical) */
    @media (orientation: portrait) {
      main { flex-direction: column; }
      .hero-panel {
        flex-direction: row; justify-content: space-between; padding: 10px 20px;
        height: 110px; /* Compacto */
        border-right: none; border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
      }
      .ball-wrapper { width: 70px; height: 70px; margin: 0; }
      .bingo-ball { font-size: 38px; }
      .hero-text { text-align: left; margin-left: 15px; flex: 1; }
      .fun-phrase { font-size: 18px; min-height: auto; margin:0; }
      .balls-left { font-size: 12px; }

      .controls-desktop { display: none; } /* Ocultar controles de PC */
      .controls-mobile {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: #fff; padding: 10px 15px calc(env(safe-area-inset-bottom) + 10px);
        box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
        z-index: 50; display: flex; gap: 8px;
        border-radius: 20px 20px 0 0;
      }
      .grid-panel { border-radius: 0; }
    }

    /* Landscape (PC / M√≥vil Tumbado) */
    @media (orientation: landscape) {
      main { flex-direction: row; }
      .hero-panel { width: 35%; max-width: 400px; padding: 20px; }
      .grid-panel { width: 65%; border-radius: 20px; margin: 10px; }
      .controls-mobile { display: none; }
      .controls-desktop { width: 100%; margin-top: auto; }
    }

    /* --- Modales --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200;
      display: grid; place-items: center; opacity: 0; pointer-events: none; transition: opacity 0.4s;
      backdrop-filter: blur(8px);
    }
    .overlay.show { opacity: 1; pointer-events: auto; }

    .card-modal {
      background: #fff; width: 90%; max-width: 450px;
      border-radius: 25px; padding: 30px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 4px solid var(--gold);
      transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      color: #333;
    }
    .overlay.show .card-modal { transform: scale(1); }

    /* Splash Screen espec√≠fica */
    #splash .card-modal {
      background: var(--bg-gradient); color: white; border-color: white;
    }
    .emoji-big { font-size: 60px; display: block; margin-bottom: 10px; animation: float 2s infinite ease-in-out; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

    input.check-input {
      font-size: 32px; text-align: center; border: 2px solid #ddd;
      border-radius: 12px; padding: 10px; width: 100%; margin: 15px 0;
      font-family: 'Poppins', sans-serif; font-weight: bold;
    }
    input.small-input{
      font-size: 18px; text-align: center; border: 2px solid #ddd;
      border-radius: 12px; padding: 10px; width: 100%;
      font-family: 'Poppins', sans-serif; font-weight: 800;
      text-transform: uppercase;
    }
    .subtle{
      opacity: 0.75;
      font-size: 12px;
      line-height: 1.25;
    }
    .hr{
      height: 1px;
      background: rgba(0,0,0,0.1);
      margin: 16px 0;
    }
    .mini-row{ display:flex; gap:10px; align-items:center; }
    .copy-pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.10);
      font-weight: 900;
      letter-spacing: 2px;
      font-size: 18px;
      user-select: all;
    }
    #qrcode{ display:grid; place-items:center; margin-top: 14px; }
  
    /* --- Ajustes Cart√≥n Jugador (fit en m√≥vil, sin scroll lateral) --- */
    .grid-container{ overflow-x: hidden; }
    #cardGrid{
      grid-template-columns: repeat(9, minmax(0, 1fr));
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      padding: 6px;
      gap: 4px;
    }
    .cell.card{
      font-size: clamp(12px, 3.6vw, 22px);
      line-height: 1;
      padding: 0;
    }
    @media (max-width: 420px){
      #cardGrid{ gap: 3px; padding: 4px; }
      .cell.card{ font-size: clamp(11px, 3.8vw, 20px); }
    }

    /* Aviso de reclamaciones (L√çNEA/BINGO) */
    .claim-banner{
      position: fixed;
      left: 12px; right: 12px;
      top: calc(env(safe-area-inset-top) + 72px);
      z-index: 300;
      background: rgba(0,0,0,0.75);
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: white;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .claim-banner strong{ color: var(--gold); }
    .claim-banner button{
      height: 36px;
      padding: 0 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.15);
      color: white;
      box-shadow: none;
      text-transform: none;
      font-weight: 800;
    }

  
    /* Panel de validaci√≥n para el master (L√çNEA/BINGO) */
    .master-claim-panel{
      position: fixed;
      left: 12px; right: 12px;
      bottom: calc(env(safe-area-inset-bottom) + 12px);
      z-index: 350;
      background: rgba(12,12,12,0.82);
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
      display: none;
    }
    .master-claim-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .master-claim-title{
      font-weight: 900;
      letter-spacing: 0.2px;
      color: #fff;
      font-size: 14px;
      line-height: 1.25;
    }
    .master-claim-title strong{ color: var(--gold); }
    .master-claim-meta{
      margin-top: 6px;
      opacity: 0.85;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
    }
    .master-claim-actions{
      display:flex;
      gap: 8px;
      flex-shrink:0;
    }
    .btn-accept, .btn-reject{
      height: 38px;
      padding: 0 12px;
      border-radius: 12px;
      font-weight: 900;
      text-transform: none;
      letter-spacing: 0.2px;
      box-shadow: none;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .btn-accept{ background: rgba(34,197,94,0.18); color: #fff; }
    .btn-reject{ background: rgba(239,68,68,0.18); color: #fff; }

  
    /* --- Fix m√≥vil: modales con scroll si no caben --- */
    .overlay{
      overflow-y: auto;
      padding: 18px 12px;
      -webkit-overflow-scrolling: touch;
    }
    .card-modal{
      max-height: calc(100vh - 36px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

  </style>
</head>
<body>

  <div class="snow"></div>
  <canvas id="confetti-canvas"></canvas>

  <div id="claimBanner" class="claim-banner">
    <div id="claimText">‚Äî</div>
    <button onclick="hideClaimBanner()">Cerrar</button>
  </div>


  <!-- PANTALLA INICIO -->
  <div class="overlay show" id="splash">
    <div class="card-modal">
      <div class="emoji-big">üéÑ</div>
      <h1 style="font-family:'Mountains of Christmas'; font-size:42px; margin:0; line-height:1;">Bingo T√≠a Finin</h1>
      <p style="opacity:0.9; margin-bottom:30px;">¬°Edici√≥n Gala de Navidad!</p>
      <button class="btn-play" style="width:100%; background:white; color:#a4161a;" onclick="startGameUI()">
        ¬°EMPEZAR FIESTA! üéâ
      </button>
      <p style="font-size:11px; margin-top:15px; opacity:0.6;">Sube el volumen y habilita el micr√≥fono.</p>
    </div>
  </div>

  <div id="masterClaimPanel" class="master-claim-panel" aria-live="polite">
    <div class="master-claim-row">
      <div style="min-width:0;">
        <div id="masterClaimTitle" class="master-claim-title">‚Äî</div>
        <div id="masterClaimMeta" class="master-claim-meta">‚Äî</div>
      </div>
      <div class="master-claim-actions">
        <button class="btn-accept" id="btnValidateClaim" onclick="validateCurrentClaim(true)">Validar</button>
        <button class="btn-reject" id="btnRejectClaim" onclick="validateCurrentClaim(false)">Rechazar</button>
      </div>
    </div>
  </div>


  <!-- LOBBY MULTIJUGADOR (SIN USUARIOS) -->
  <div class="overlay" id="lobbyModal">
    <div class="card-modal" style="border-color: var(--gold);">
      <h2 style="margin:0; font-family:'Mountains of Christmas'; color:#a4161a; font-size:34px;">Modo Familia</h2>
      <p class="subtle" style="margin:10px 0 18px;">Crea una sala y comparte el c√≥digo (o el QR). Cada m√≥vil tendr√° su cart√≥n y se marcar√° solo. <strong>Las siguientes partidas se reinician en la misma sala</strong>.</p>

      <input id="playerNameInput" class="small-input" placeholder="Tu nombre (OBLIGATORIO)" maxlength="16" style="margin-bottom:12px;" />
      <p class="subtle" style="margin:-6px 0 12px;">Escribe tu nombre para que el master lo oiga cuando cantes L√çNEA/BINGO.</p>

      <div class="btn-row" style="flex-direction: column;">
        <button class="btn-play" id="btnCreateRoom" style="width:100%;" onclick="createRoom()">‚ûï Crear sala</button>
      </div>

      <div class="hr"></div>

      <div class="mini-row" style="margin-bottom:10px;">
        <input id="roomCodeInput" class="small-input" placeholder="C√ìDIGO" maxlength="8" style="flex:1;" />
        <button class="btn-action" style="width:120px;" onclick="joinRoom()">Entrar</button>
      </div>

      <div id="roomCreated" style="display:none;">
        <div style="margin-top:10px; font-weight:900;">C√≥digo de sala:</div>
        <div class="copy-pill" id="roomCodePill">------</div>

        <div class="btn-row" style="margin-top:12px;">
          <button class="btn-linea" onclick="copyRoomLink()">üìã Copiar link</button>
          <button class="btn-action" onclick="copyRoomCode()">üìã Copiar c√≥digo</button>
        </div>

        <div id="qrcode"></div>
        <p class="subtle" style="margin:10px 0 0;">En m√≥vil: abre la c√°mara y apunta al QR.</p>
      </div>

      <div class="btn-row" style="margin-top:16px;">
        <button class="btn-action" style="flex:1;" onclick="closeOverlay('lobbyModal')">Cerrar</button>
        <button class="btn-bingo" style="flex:1;" id="btnContinue"  onclick="continueFromLobby()">Entrar</button>
      </div>

      <p class="subtle" id="nameError" style="margin-top:10px; color:#b42318; display:none; font-weight:900;">‚ö†Ô∏è Pon tu nombre para entrar.</p>

      <p class="subtle" id="firebaseHint" style="margin-top:14px; display:none;">
        ‚ö†Ô∏è Falta configurar Firebase (apiKey / databaseURL). En este modo solo funciona local.
      </p>
    </div>
  </div>

  <div class="app">
    <header>
      <div class="logo">T√≠a Finin ü•Ç</div>
      <div class="status-badge" id="statusBadge" style="color:#fff;">Esperando...</div>

      <!-- CONTROLES SUPERIORES: MICRO Y AJUSTES -->
      <div class="header-controls">
        <button id="micBtn" class="mic-btn" onclick="toggleVoice()">üéôÔ∏è</button>
        <button onclick="toggleSettings()" style="background:rgba(255,255,255,0.2); width:40px; height:40px; border-radius:50%; color:white;">‚öôÔ∏è</button>
      </div>
    </header>

    <main>
      <!-- Panel Izquierdo / Superior -->
      <section class="hero-panel">
        <div class="ball-wrapper">
          <div class="bingo-ball" id="mainBall">
            <span id="ballNum">?</span>
          </div>
        </div>

        <div class="hero-text">
          <div class="fun-phrase" id="funPhrase">¬°Prepara el cart√≥n!</div>
          <div class="balls-left" id="ballsLeft">90 bolas en el bombo</div>
        </div>

        <!-- Controles Desktop (Landscape) -->
        <div class="controls-wrapper controls-desktop">
          <div class="btn-row">
            <button class="btn-action" onclick="speakLast()">üó£ Repetir</button>
            <button class="btn-play" id="btnAutoL" onclick="toggleAuto()">‚ñ∂ INICIAR</button>
          </div>
          <div class="btn-row">
            <button class="btn-linea" id="btnLineL" disabled onclick="claimWin('L√çNEA')">L√çNEA</button>
            <button class="btn-bingo" id="btnBingoL" disabled onclick="claimWin('BINGO')">BINGO</button>
          </div>
          <button class="btn-action" style="margin-top:10px; width:100%; background:#eef;" onclick="openCheck()">üîç Comprobar N√∫mero</button>
          <button class="btn-action" style="margin-top:0; width:100%;" onclick="openLobby()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Sala</button>
        </div>
      </section>

      <!-- Panel Derecho / Inferior -->
      <section class="grid-panel">
        <div class="grid-header" id="gridHeader">
          <span id="gridTitle">Cart√≥n Maestro (1-90)</span>
          <span class="tiny-pill" id="rolePill" style="display:none;">‚Äî</span>
        </div>
        <div class="grid-container">
          <div class="grid" id="grid"></div>

          <!-- Cart√≥n del jugador -->
          <div id="cardWrap" style="display:none;">
            <div class="card-grid" id="cardGrid"></div>
          </div>
        </div>
      </section>

      <!-- Controles M√≥vil (Sticky Bottom) -->
      <div class="controls-mobile">
        <button class="btn-play" id="btnAutoM" style="flex:2;" onclick="toggleAuto()">‚ñ∂</button>
        <button class="btn-action" style="flex:1; background:#eef;" onclick="openCheck()">üîç</button>
        <button class="btn-linea" id="btnLineM" disabled onclick="claimWin('L√çNEA')">L√çNEA</button>
        <button class="btn-bingo" id="btnBingoM" disabled onclick="claimWin('BINGO')">BINGO</button>
      </div>
    </main>
  </div>

  <!-- Modal Comprobador -->
  <div class="overlay" id="checkModal">
    <div class="card-modal">
      <h2 style="margin:0; font-family:'Mountains of Christmas'; color:#a4161a; font-size:32px;">Comprobar</h2>
      <input type="number" id="checkInput" class="check-input" placeholder="N¬∫">
      <div id="checkMsg" style="min-height:30px; font-weight:bold; font-size:18px; margin-bottom:15px;"></div>
      <div class="btn-row">
        <button class="btn-linea" onclick="checkNum()">Mirar</button>
        <button class="btn-action" onclick="closeOverlay('checkModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ajustes -->
  <div class="overlay" id="settingsModal">
    <div class="card-modal">
      <h2>Opciones</h2>
      <button class="btn-bingo" id="btnResetShared" style="width:100%; margin-bottom:12px;" onclick="resetGame()">‚ôªÔ∏è NUEVA PARTIDA (MISMA SALA)</button>
      <button class="btn-action" id="btnNewCard" style="width:100%; margin-bottom:15px;" onclick="newCard()">üéüÔ∏è Nuevo cart√≥n (solo mi m√≥vil)</button>
      <button class="btn-action" style="width:100%;" onclick="closeOverlay('settingsModal')">Volver</button>
    </div>
  </div>

  <!-- Firebase (Realtime Database) + QR -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    /* =========================================================
       ‚úÖ MULTIJUGADOR SIN USUARIOS (Firebase Realtime Database)
       - Host crea sala => c√≥digo
       - Jugadores entran con c√≥digo => cart√≥n propio
       - Los n√∫meros se sincronizan y se marcan solos
       ========================================================= */

    /* 1) Pega aqu√≠ tu config de Firebase (Project settings -> Web app) */
    const firebaseConfig = {
      apiKey: "AIzaSyB1Y54b0TOF81vUMDqOUfIupcZ4idyBYf4",
  authDomain: "bingofamilia-91b77.firebaseapp.com",
  databaseURL: "https://bingofamilia-91b77-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bingofamilia-91b77",
  storageBucket: "bingofamilia-91b77.firebasestorage.app",
  messagingSenderId: "409897347724",
  appId: "1:409897347724:web:f834270d88d206556c29a9",
  measurementId: "G-LL3GYMK4ET"
    };

    const FIREBASE_ENABLED =
      firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("REPLACE_ME") &&
      firebaseConfig.databaseURL && !firebaseConfig.databaseURL.includes("REPLACE_ME");

    let db = null;
    let auth = null;
    let authReady = null;

    if (FIREBASE_ENABLED) {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      auth = firebase.auth();

      authReady = new Promise((resolve) => {
        auth.onAuthStateChanged((user) => {
          if (user) {
            state.uid = user.uid;
            resolve(user);
          }
        });
      });

      // Login an√≥nimo autom√°tico (sin pantallas, sin cuentas)
      auth.signInAnonymously().catch((e)=>console.error("Auth anon error:", e));
    }

    /* --- FRASES DE LA T√çA FININ (Base de datos AMPLIADA) --- */
    const JOKES = {
      1: "El gal√°n... ¬°Peque√±o pero mat√≥n!",
      2: "El patito... feo, como el novio de tu prima.",
      3: "San Cono... t√≥camelo que me emociono.",
      4: "La cama... ¬°donde se hacen los negocios!",
      5: "El gato... miau miau, ¬°ara√±a!",
      6: "El coraz√≥n... de la T√≠a Finin.",
      7: "El rev√≥lver... ¬°pum pum! Balas de fogueo.",
      8: "El incendio... ¬°Llamad a los bomberos que hay fuego!",
      9: "El arroyo... cuidado que te mojas.",
      10: "La rosa... ¬°Pa ti, guapa!",
      11: "Los dos palitos... ¬°Vaya piernas de alambre!",
      12: "El soldado... ¬°Firmes, ar!",
      13: "La mala pata... ¬°La que metiste en Nochebuena!",
      15: "La ni√±a bonita... ¬°Cuidado con los moscones!",
      20: "La fiesta... ¬°Que corra el champ√°n!",
      22: "Los dos patitos... ¬°Cuack cuack! ¬°Qu√© pechugas!",
      25: "Navidad... ¬°Ponedme otro polvor√≥n!",
      33: "La edad de Cristo... ¬°Ay se√±or, dame paciencia!",
      40: "La cura... ¬°O la locura de esta familia!",
      44: "Los tacones... ¬°Para pisar a la suegra!",
      50: "El pan... ¬°Con jam√≥n del bueno, eh!",
      55: "Los musicales... ¬°C√°ntate algo, Paquita!",
      66: "Las monjas... ¬°A rezar pecadores!",
      69: "El vicio... ¬°Arriba y abajo! ¬°Qu√© calor!",
      70: "El muerto... ¬°Ese no se levanta ni con gr√∫a!",
      75: "El beso... ¬°Pero con lengua!",
      88: "Las calabazas... ¬°Las que te dio el del pueblo!",
      90: "El abuelo... ¬°Despierta abuelo, que nos vamos!",
      generic: [
        "¬°M√°rcalo bien que no ves n√°!",
        "¬°Remueve el bombo, Manolo!",
        "Este n√∫mero me da buena espina.",
        "¬øQui√©n lo tiene? ¬°Que cante!",
        "¬°Venga alegr√≠a, que paga la abuela!",
        "¬°A ver si nos toca el gordo!",
        "¬°Ese cart√≥n est√° pidiendo premio!",
        "¬°Ni√±o, deja el m√≥vil y mira el cart√≥n!",
        "¬°Uy, casi, casi! ¬øLo tienes?",
        "¬°Si cantas l√≠nea te doy un beso!",
        "¬°Que se enfr√≠an los langostinos!",
        "¬°Ay qu√© nervios, por Dios!",
        "¬°Me est√° entrando una sed...!",
        "¬°Este n√∫mero huele a premio gordo!",
        "¬°No os durm√°is que pierdo el hilo!",
        "¬°Otro m√°s pa' la saca!",
        "¬°Mira bien, no te lo saltes!",
        "¬°Ese n√∫mero es de los bonitos!",
        "¬°A ver esa suerte de principiante!",
        "¬°T√≠a Finin os est√° vigilando!",
        "¬°Si no sale el tuyo, no te enfades!",
        "¬°Venga, que quiero ver billetes!",
        "¬°Atenci√≥n, atenci√≥n, n√∫mero importante!",
        "¬°Ojo al dato, se√±oras y se√±ores!",
        "¬°B√∫scalo bien, que est√° escondido!",
        "¬°Vaya racha llevamos, eh!",
        "¬°Saca la bota de vino, Paco!",
        "¬°Como toque reparto, lo juro!",
        "¬°Ay madre, que me da un patat√∫s!",
        "¬°Dale alegr√≠a a tu cuerpo Macarena!",
        "¬°Este lo tiene mi cu√±ado seguro!",
        "¬°Mueve el esqueleto, que sale el n√∫mero!",
        "¬°Silencio en la sala, que sale la bola!",
        "¬°Apunta, apunta, que no se te escape!",
        "¬°Ese n√∫mero tiene guasa!",
        "¬°Venga, que nos dan las uvas!",
        "¬°A ver si espabilamos, familia!",
        "¬°No hag√°is trampas que os veo!",
        "¬°Ese cart√≥n est√° muy vac√≠o todav√≠a!",
        "¬°Qui√©n cante bingo friega los platos!",
        "¬°Vamos que nos vamos!"
      ]
    };

    function getJoke(num){
      if(!num) return "¬°Prepara el cart√≥n!";
      if(JOKES[num]) return JOKES[num];
      return JOKES.generic[Math.floor(Math.random() * JOKES.generic.length)];
    }

    /* --- ESTADO --- */
    let state = {
      // local
      deck: [],
      // shared (online)
      roomId: null,
      role: "local", // local | host | player
      uid: null,
      card: null,
      called: [],
      currentNumber: null,
      lastJoke: null,
      roomStatus: "LISTO",
      lineWinner: null,
      bingoWinner: null,
      _autoLineSent: false,
      _autoBingoSent: false,

      running: false,
      timer: null,
      speed: 4500
    };

    /* --- DOM ELEMENTS --- */
    const $ = id => document.getElementById(id);
    const els = {
      ball: $('ballNum'), ballWrap: $('mainBall'),
      phrase: $('funPhrase'), left: $('ballsLeft'), grid: $('grid'),
      btnAutoL: $('btnAutoL'), btnAutoM: $('btnAutoM'),
      btnLineL: $('btnLineL'), btnLineM: $('btnLineM'),
      btnBingoL: $('btnBingoL'), btnBingoM: $('btnBingoM'),
      status: $('statusBadge'), checkIn: $('checkInput'), checkMsg: $('checkMsg'),
      micBtn: $('micBtn'),
      gridTitle: $('gridTitle'),
      rolePill: $('rolePill'),
      cardWrap: $('cardWrap'),
      cardGrid: $('cardGrid'),
      firebaseHint: $('firebaseHint'),
      btnResetShared: $('btnResetShared')
    };

    /* --- UI: construir tablero maestro una vez --- */
    function buildMasterGridOnce(){
      if(els.grid.dataset.built === "1") return;
      els.grid.innerHTML = '';
      for(let i=1; i<=90; i++){
        let div = document.createElement('div');
        div.className = 'cell';
        div.id = `cell-${i}`;
        div.innerText = i;
        els.grid.appendChild(div);
      }
      els.grid.dataset.built = "1";
    }

    function setStatus(text, color){
      els.status.innerText = text;
      if(color) els.status.style.color = color;
      else els.status.style.color = "#fff";
    }

    function updateRoleUI(){
      if(state.role === "player"){
        els.gridTitle.innerText = "Mi Cart√≥n";
        els.rolePill.style.display = "inline-flex";
        els.rolePill.innerText = state.roomId ? `SALA ${state.roomId} ¬∑ JUGADOR` : "JUGADOR";
        els.grid.style.display = "none";
        els.cardWrap.style.display = "block";
      } else {
        els.gridTitle.innerText = "Cart√≥n Maestro (1-90)";
        if(state.role === "host"){
          els.rolePill.style.display = "inline-flex";
          els.rolePill.innerText = state.roomId ? `SALA ${state.roomId} ¬∑ HOST` : "HOST";
        } else if(state.role === "local"){
          els.rolePill.style.display = "none";
        }
        els.grid.style.display = "grid";
        els.cardWrap.style.display = "none";
      }

      // Bot√≥n reinicio: en online solo el host deber√≠a usarlo (aun as√≠, no ‚Äúbloqueamos‚Äù fuerte)
      if(state.role === "player"){
        els.btnResetShared.disabled = true;
        els.btnResetShared.style.opacity = 0.5;
      } else {
        els.btnResetShared.disabled = false;
        els.btnResetShared.style.opacity = 1;
      }
    }

    /* --- INICIO (local) --- */
    function initLocalGame() {
      // 1. Crear baraja
      state.deck = Array.from({length: 90}, (_, i) => i + 1);
      // Shuffle Fisher-Yates
      for (let i = state.deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [state.deck[i], state.deck[j]] = [state.deck[j], state.deck[i]];
      }

      state.called = [];
      state.currentNumber = null;
      state.lastJoke = null;
      state.running = false;
      clearInterval(state.timer);

      // UI Reset
      els.ball.innerText = "?";
      els.phrase.innerText = "¬°Prepara el cart√≥n!";
      els.left.innerText = "90 bolas";
      els.ballWrap.classList.remove('pop');
      setStatus("LISTO", "#fff");

      buildMasterGridOnce();
      // limpiar marcas
      for(let i=1;i<=90;i++){
        const c = $(`cell-${i}`);
        if(c) c.classList.remove("marked","last");
      }

      updateRoleUI();
      updateButtons();
      requestWakeLock();
    }

    /* --- Aplicar estado compartido a UI --- */
    function applyCalledToMasterGrid(called, lastNum){
      buildMasterGridOnce();
      // Quitar last anterior
      document.querySelectorAll('#grid .cell.last').forEach(c => c.classList.remove('last'));

      const calledSet = new Set(called || []);
      for(let i=1;i<=90;i++){
        const cell = $(`cell-${i}`);
        if(!cell) continue;
        if(calledSet.has(i)) cell.classList.add("marked");
        else cell.classList.remove("marked");

        if(i === lastNum && calledSet.has(i)) cell.classList.add("last");
      }

      if(lastNum){
        const cell = $(`cell-${lastNum}`);
        if(cell) cell.scrollIntoView({behavior:"smooth", block:"nearest", inline:"nearest"});
      }
    }

    function renderCard(card){
      els.cardGrid.innerHTML = "";
      if(!card) return;

      // card: 3x9 with nulls
      for(let r=0;r<3;r++){
        for(let c=0;c<9;c++){
          const val = card[r][c];
          const div = document.createElement("div");
          div.className = "cell card" + (val ? "" : " empty");
          if(val){
            div.textContent = val;
            div.dataset.num = String(val);
          } else {
            div.textContent = "¬∑";
          }
          els.cardGrid.appendChild(div);
        }
      }
    }

    function applyCalledToCard(called, lastNum){
      const calledSet = new Set(called || []);
      document.querySelectorAll('#cardGrid .cell.card').forEach(cell=>{
        const n = parseInt(cell.dataset.num || "0", 10);
        if(!n) return;
        cell.classList.toggle("marked", calledSet.has(n));
        cell.classList.toggle("last", n === lastNum && calledSet.has(n));
      });
    }

    function updateUIFromShared(){
      const called = state.called || [];
      const lastNum = state.currentNumber || (called.length ? called[called.length-1] : null);

      // Animaci√≥n bola
      if(lastNum){
        els.ballWrap.classList.remove('pop');
        void els.ballWrap.offsetWidth;
        els.ballWrap.classList.add('pop');
      }

      els.ball.innerText = lastNum ? lastNum : "?";
      els.left.innerText = `Quedan ${Math.max(0, 90 - called.length)}`;

      const joke = state.lastJoke || getJoke(lastNum);
      els.phrase.innerText = joke.replace(`¬°${lastNum}!`, '').trim();
      // Voz solo cuando entra un n√∫mero nuevo (evitar repetir al reconectar)
      // -> se controla con lastSpokenNumber
      maybeSpeakNewNumber(lastNum, joke);

      if(state.role === "host"){
        applyCalledToMasterGrid(called, lastNum);
      } else if(state.role === "player"){
        applyCalledToCard(called, lastNum);
      } else {
        applyCalledToMasterGrid(called, lastNum);
      }

      updateButtons();
    }

    /* --- L√ìGICA LOCAL --- */
    function drawBallLocal() {
      if(state.deck.length === 0) {
        stopGame();
        speak("¬°Se acab√≥ lo que se daba!");
        return;
      }

      els.ballWrap.classList.remove('pop');
      void els.ballWrap.offsetWidth;
      els.ballWrap.classList.add('pop');

      const num = state.deck.pop();
      state.called.push(num);
      state.currentNumber = num;
      state.lastJoke = getJoke(num);

      els.ball.innerText = num;
      els.left.innerText = `Quedan ${state.deck.length}`;

      const cell = $(`cell-${num}`);
      if(cell) {
        document.querySelectorAll('.cell.last').forEach(c => c.classList.remove('last'));
        cell.classList.add('marked', 'last');
        cell.scrollIntoView({behavior:"smooth", block:"nearest", inline:"nearest"});
      }

      const joke = state.lastJoke;
      els.phrase.innerText = joke.replace(`¬°${num}!`, '').trim();
      speak(`${num}. ${joke}`);

      updateButtons();
    }

    /* --- L√ìGICA ONLINE --- */
    function roomRef(path=""){
      return db.ref(`rooms/${state.roomId}${path}`);
    }
    function stateRef(){
      return roomRef(`/state`);
    }
    function hostsRef(){
      return roomRef(`/hosts`);
    }
    function myPlayerRef(){
      return roomRef(`/players/${state.uid}`);
    }

    async function onlineDrawBall(){
      if(!FIREBASE_ENABLED || !db) return;
      if(state.role !== "host") return;
      await authReady;

      const rRef = stateRef();
      await rRef.transaction((st)=>{
        if(!st) return st;
        const called = Array.isArray(st.called) ? st.called : [];
        const calledSet = new Set(called);

        const remaining = [];
        for(let i=1;i<=90;i++){
          if(!calledSet.has(i)) remaining.push(i);
        }
        if(remaining.length === 0){
          st.status = "FIN";
          st.currentNumber = null;
          st.updatedAt = Date.now();
          return st;
        }

        const num = remaining[Math.floor(Math.random() * remaining.length)];
        called.push(num);

        st.called = called;
        st.currentNumber = num;
        st.lastJoke = getJoke(num);
        st.status = "EN MARCHA";
        st.updatedAt = Date.now();
        return st;
      });
    }

    function toggleAuto() {
      // Online: solo el host puede sacar bolas
      if(FIREBASE_ENABLED && state.role !== "local"){
        if(state.role !== "host"){
          speak("Aqu√≠ manda el host. T√∫ solo marca el cart√≥n.");
          return;
        }

        if(state.running) {
          stopGame();
          stateRef().update({status: "PAUSA"});
          speak("Pausamos un momento.");
        } else {
          state.running = true;
          stateRef().update({status: "EN MARCHA"});
          if((state.called||[]).length === 0) speak("¬°Empieza el Bingo de la T√≠a Finin!");
          onlineDrawBall();
          state.timer = setInterval(onlineDrawBall, state.speed);
        }
        updateButtons();
        return;
      }

      // Local
      if(state.running) {
        stopGame();
        speak("Pausamos un momento.");
      } else {
        state.running = true;
        setStatus("EN MARCHA", "#4ade80");
        if(state.called.length === 0) speak("¬°Empieza el Bingo de la T√≠a Finin!");
        drawBallLocal();
        state.timer = setInterval(drawBallLocal, state.speed);
      }
      updateButtons();
    }

    function stopGame() {
      state.running = false;
      clearInterval(state.timer);

      if(FIREBASE_ENABLED && state.role !== "local"){
        // status viene del servidor, pero lo reflejamos
        setStatus("PAUSA", "var(--gold)");
      } else {
        setStatus("PAUSA", "var(--gold)");
      }
      updateButtons();
    }

    function updateButtons() {
      // Activaci√≥n de botones por bolas
      const calledCount = (state.called || []).length;
      const hasBalls = calledCount > 0;

      // Por defecto: habilitar si hay bolas
      [els.btnLineL, els.btnLineM, els.btnBingoL, els.btnBingoM].forEach(b => b.disabled = !hasBalls);

      // Si ya se concedi√≥ L√çNEA/BINGO en la sala, desactivamos esos botones (solo una vez por partida)
      const lineDone = !!state.lineWinner;
      const bingoDone = !!state.bingoWinner;

      if(lineDone){
        els.btnLineL.disabled = true;
        els.btnLineM.disabled = true;
      }
      if(bingoDone){
        els.btnBingoL.disabled = true;
        els.btnBingoM.disabled = true;
      }

      // Auto text & enabled
      if(FIREBASE_ENABLED && state.role !== "local"){
        if(state.role === "host"){
          const txt = state.running ? "‚è∏ PAUSAR" : (hasBalls ? "‚ñ∂ SEGUIR" : "‚ñ∂ INICIAR");
          els.btnAutoL.innerText = txt;
          els.btnAutoM.innerText = txt;
          els.btnAutoL.disabled = false;
          els.btnAutoM.disabled = false;
        } else {
          els.btnAutoL.innerText = "‚åõ ESPERANDO";
          els.btnAutoM.innerText = "‚åõ ESPERANDO";
          els.btnAutoL.disabled = true;
          els.btnAutoM.disabled = true;
        }

        // Status badge desde roomStatus
        if(state.bingoWinner){
          setStatus(`BINGO: ${state.bingoWinner}`, "#fff");
        } else if(state.lineWinner){
          setStatus(`L√çNEA: ${state.lineWinner}`, "var(--gold)");
        } else if(state.roomStatus === "EN MARCHA"){
          setStatus("EN MARCHA", "#4ade80");
        } else if(state.roomStatus === "PAUSA"){
          setStatus("PAUSA", "var(--gold)");
        } else if(state.roomStatus === "FIN"){
          setStatus("FIN", "#fff");
        } else {
          setStatus("LISTO", "#fff");
        }
      } else {
        const txt = state.running ? "‚è∏ PAUSAR" : (hasBalls ? "‚ñ∂ SEGUIR" : "‚ñ∂ INICIAR");
        els.btnAutoL.innerText = txt;
        els.btnAutoM.innerText = txt;
        els.btnAutoL.disabled = false;
        els.btnAutoM.disabled = false;
      }
    }

    /* --- INTERACCI√ìN Y FIESTA --- */
    function handleWin(type) {
      stopGame();
      fireConfetti();
      speak(`¬°Atenci√≥n familia! Han cantado ${type}. Vamos a comprobar.`);
      setTimeout(() => {
        alert(`üéâ ¬°¬°HAN CANTADO ${type}!! üéâ\n\nNo toqu√©is nada. Vamos a comprobar el cart√≥n.`);
      }, 500);
    }

    function showClaimBanner(msg){
      const b = document.getElementById('claimBanner');
      const t = document.getElementById('claimText');
      if(!b || !t) return;
      t.innerHTML = msg;
      b.style.display = "flex";
      clearTimeout(window.__claimTimer);
      window.__claimTimer = setTimeout(()=>{ b.style.display="none"; }, 6500);
    }
    window.hideClaimBanner = () => {
      const b = document.getElementById('claimBanner');
      if(b) b.style.display = "none";
    };

    
    function getCardNumbersByRow(card){
      // card: 3x9 con nulls
      const rows = [[],[],[]];
      for(let r=0;r<3;r++){
        for(let c=0;c<9;c++){
          const v = card[r][c];
          if(v) rows[r].push(v);
        }
      }
      return rows; // cada fila tendr√° 5 nums
    }

    function maybeAutoClaim(){
      // Solo en online y solo para jugadores (o host si juega con cart√≥n)
      if(!FIREBASE_ENABLED || (state.role !== "player" && state.role !== "host")) return;
      if(!state.card || !(state.called && state.called.length)) return;

      const calledSet = new Set(state.called);
      const rows = getCardNumbersByRow(state.card);

      // ‚úÖ L√çNEA (solo una vez por partida)
      if(!state._autoLineSent && !state.lineWinner){
        const hasLine = rows.some(row => row.every(n => calledSet.has(n)));
        if(hasLine){
          state._autoLineSent = true;
          // Reclamamos autom√°ticamente
          claimWin('L√çNEA');
        }
      }

      // ‚úÖ BINGO (una vez por partida)
      if(!state._autoBingoSent && !state.bingoWinner){
        const allNums = rows.flat();
        const hasBingo = allNums.every(n => calledSet.has(n));
        if(hasBingo){
          state._autoBingoSent = true;
          claimWin('BINGO');
        }
      }
    }

    async function claimWin(type){
      // En modo local, hacemos lo de siempre
      if(!FIREBASE_ENABLED || state.role === "local"){
        handleWin(type);
        return;
      }

    // --- Reclamaciones: panel bonito para el master + feedback para jugadores ---
    const claimQueue = [];
    let currentClaim = null;

    function formatTs(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      }catch(e){ return ""; }
    }

    function showMasterClaimPanel(claim){
      const panel = document.getElementById('masterClaimPanel');
      const title = document.getElementById('masterClaimTitle');
      const meta = document.getElementById('masterClaimMeta');
      if(!panel || !title || !meta) return;

      const type = claim.type || "PREMIO";
      const name = claim.name || "Jugador";
      title.innerHTML = `üì£ <strong>${name}</strong> reclama <strong>${type}</strong>`;
      const last = claim.lastNumber ? ` ¬∑ √∫ltimo: ${claim.lastNumber}` : "";
      meta.textContent = `Hora: ${formatTs(claim.at || Date.now())}${last} ¬∑ bolas: ${claim.calledCount || 0}`;
      panel.style.display = "block";
    }

    function hideMasterClaimPanel(){
      const panel = document.getElementById('masterClaimPanel');
      if(panel) panel.style.display = "none";
    }

    function pumpClaimQueue(){
      if(state.role !== "host") return;
      if(currentClaim) return;
      if(!claimQueue.length) { hideMasterClaimPanel(); return; }

      currentClaim = claimQueue.shift();
      showMasterClaimPanel(currentClaim);
      speak(`Atenci√≥n. ${currentClaim.name || "Un jugador"} ha cantado ${currentClaim.type || "premio"}.`);
      // Tambi√©n mostramos el banner general
      showClaimBanner(`üì£ <strong>${currentClaim.name || "Jugador"}</strong> ha cantado <strong>${currentClaim.type || "PREMIO"}</strong>`);
    }

    async function validateCurrentClaim(isValid){
      if(state.role !== "host" || !currentClaim) return;
      try{
        await authReady;

        const uid = currentClaim.uid;
        const type = currentClaim.type;

        // Si ya existe ganador para ese tipo, forzamos rechazo aunque el usuario pulse validar
        if(type === "L√çNEA" && state.lineWinner) isValid = false;
        if(type === "BINGO" && state.bingoWinner) isValid = false;

        if(isValid){
          if(type === "L√çNEA"){
            await stateRef().update({ lineWinner: currentClaim.name || "Jugador", status: "PAUSA", updatedAt: Date.now() });
            await roomRef(`/claims/${uid}`).update({ status: "ACCEPTED", resolvedAt: Date.now(), resolvedBy: state.uid });
            showClaimBanner(`‚úÖ L√çNEA validada para <strong>${currentClaim.name || "Jugador"}</strong>`);
          } else if(type === "BINGO"){
            await stateRef().update({ bingoWinner: currentClaim.name || "Jugador", status: "FIN", updatedAt: Date.now() });
            await roomRef(`/claims/${uid}`).update({ status: "ACCEPTED", resolvedAt: Date.now(), resolvedBy: state.uid });
            showClaimBanner(`üèÜ BINGO validado para <strong>${currentClaim.name || "Jugador"}</strong>`);
          } else {
            await roomRef(`/claims/${uid}`).update({ status: "ACCEPTED", resolvedAt: Date.now(), resolvedBy: state.uid });
            showClaimBanner(`‚úÖ Premio validado para <strong>${currentClaim.name || "Jugador"}</strong>`);
          }
        } else {
          await roomRef(`/claims/${uid}`).update({ status: state.lineWinner || state.bingoWinner ? "ALREADY" : "REJECTED", resolvedAt: Date.now(), resolvedBy: state.uid });
          showClaimBanner(`‚ùå Reclamaci√≥n rechazada (${currentClaim.name || "Jugador"})`);
        }

      }catch(e){
        console.error(e);
        alert("No se pudo validar/rechazar. Revisa reglas o conexi√≥n.");
      }finally{
        currentClaim = null;
        hideMasterClaimPanel();
        setTimeout(pumpClaimQueue, 150);
      }
    }

    function listenMyClaimStatus(){
      if(!FIREBASE_ENABLED || !state.uid || !state.roomId) return;
      // Escucha mi propia reclamaci√≥n (para feedback al jugador)
      roomRef(`/claims/${state.uid}`).off();
      roomRef(`/claims/${state.uid}`).on("value", (snap)=>{
        const c = snap.val();
        if(!c || !c.status) return;
        if(c.status === "ACCEPTED"){
          showClaimBanner(`‚úÖ <strong>${c.type || "Premio"}</strong> validado por el master.`);
          speak(`${c.type || "Premio"} validado.`);
        }
        if(c.status === "REJECTED"){
          showClaimBanner(`‚ùå <strong>${c.type || "Premio"}</strong> rechazado.`);
          speak(`${c.type || "Premio"} rechazado.`);
        }
        if(c.status === "ALREADY"){
          showClaimBanner(`‚ÑπÔ∏è La <strong>${c.type || "reclamaci√≥n"}</strong> ya estaba concedida.`);
        }
      });
    }

      // En online: el jugador reclama L√çNEA/BINGO, y el master lo ve
      try{
        await authReady;
        const nameSnap = await myPlayerRef().child('name').get();
        const pname = nameSnap.exists() ? nameSnap.val() : (getName() || 'Jugador');
        const payload = {
          type,
          status: "PENDING",
          name: pname,
          uid: state.uid,
          at: Date.now(),
          lastNumber: state.currentNumber || null,
          calledCount: (state.called || []).length
        };
        await roomRef(`/claims/${state.uid}`).set(payload);

        // feedback al jugador
        fireConfetti();
        speak(`Reclamaci√≥n enviada: ${type}.`);
        showClaimBanner(`‚úÖ Has reclamado <strong>${type}</strong>. El master lo est√° comprobando‚Ä¶`);
      }catch(e){
        console.error(e);
        alert("No se pudo enviar la reclamaci√≥n. Revisa conexi√≥n o reglas.");
      }
    }

    function checkNum() {
      const val = parseInt(els.checkIn.value);
      if(!val) return;

      const called = state.called || [];
      if(called.includes(val)) {
        els.checkMsg.innerHTML = `<span style="color:#2d6a4f; font-size:24px;">‚úÖ S√ç, SALI√ì</span>`;
        speak(`El ${val} s√≠ ha salido. ¬°Muy bien!`);
      } else {
        els.checkMsg.innerHTML = `<span style="color:#d00000; font-size:24px;">‚ùå NO HA SALIDO</span>`;
        speak(`El ${val} no ha salido. ¬°L√≠mpiate las gafas!`);
      }
    }

    /* --- UTILS --- */
    function speak(text) {
      if(!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'es-ES';
      utter.rate = 1.0;
      utter.pitch = 1.1;
      window.speechSynthesis.speak(utter);
    }

    let lastSpoken = null;
    function maybeSpeakNewNumber(num, joke){
      if(!num) return;
      if(lastSpoken === num) return;
      lastSpoken = num;
      // En jugadores baja un poco el ‚Äúspam‚Äù de voz
      if(state.role === "player") return;
      speak(`${num}. ${joke}`);
    }

    function speakLast() {
      const called = state.called || [];
      if(called.length) speak(`Repito: ${called[called.length-1]}`);
    }

    function startGameUI() {
      $('splash').classList.remove('show');

      // Si venimos con #ROOM en la url, intentamos unirnos autom√°ticamente
      const hash = (location.hash || "").replace("#","").trim().toUpperCase();
      if(hash){
        $('roomCodeInput').value = hash;
      }

      // Si no est√° Firebase configurado, lo avisamos y dejamos modo local
      if(!FIREBASE_ENABLED){
        els.firebaseHint.style.display = "block";
      } else {
        els.firebaseHint.style.display = "none";
      }

      // Abrir lobby siempre (para que la familia elija sala)
      openLobby();
      updateLobbyButtons();

      // ‚Äúdespertar‚Äù audio context tras gesto usuario
      new (window.AudioContext || window.webkitAudioContext)();

      // Micro (si quieres): lo dejamos como en tu versi√≥n original
      setTimeout(() => {
        if(!isListening) toggleVoice();
      }, 1000);

      // base local preparada (por si falla el online)
      buildMasterGridOnce();
      initLocalGame();

      // ‚úÖ Auto-join: si hay hash y Firebase est√° listo, entra sin tocar nada m√°s
      if(hash && FIREBASE_ENABLED){
        const stored = getStoredName(hash);
        if(stored) $('playerNameInput').value = stored;

        (async () => {
          try{
            if(!requireName()) return;
            await joinRoom();       // crea/recupera cart√≥n
            enterRoomUI();          // cierra lobby y muestra cart√≥n
          }catch(e){
            console.error(e);
          }
        })();
      }
    }
    function resetGame() {
      if(state.role === "player"){
        alert("Solo el host puede reiniciar la partida üôÇ");
        return;
      }

    async function newCard(){
      if(!FIREBASE_ENABLED || state.role === "local"){
        alert("Esto solo tiene sentido en modo sala familiar üôÇ");
        return;
      }
      try{
        await authReady;
        const card = generateCard90();
        state.card = card;
        await myPlayerRef().update({ card, joinedAt: Date.now() });
        renderCard(state.card);
        applyCalledToCard(state.called, state.currentNumber);
        showClaimBanner("üéüÔ∏è Nuevo cart√≥n generado en este m√≥vil.");
      }catch(e){
        console.error(e);
        alert("No se pudo generar un nuevo cart√≥n.");
      }
    }

      if(confirm("¬øSeguro que quieres borrar la partida?")) {
        closeOverlay('settingsModal');

        if(FIREBASE_ENABLED && state.role === "host"){
          // Reinicio compartido (mantiene cartones de jugadores)
          stateRef().update({
            called: [],
            currentNumber: null,
            lastJoke: null,
            lineWinner: null,
            bingoWinner: null,
            status: "LISTO",
            updatedAt: Date.now()
          });
          // Limpiar reclamaciones para la nueva partida
          roomRef(`/claims`).remove().catch(()=>{});
          state.running = false;
          clearInterval(state.timer);
          lastSpoken = null;
          speak("Partida reiniciada.");
        } else {
          initLocalGame();
        }
      }
    }

    // Modales
    window.openCheck = () => {
      if(state.running) stopGame();
      $('checkModal').classList.add('show');
      els.checkIn.value = '';
      els.checkMsg.innerHTML = '';
      els.checkIn.focus();
    };
    window.toggleSettings = () => $('settingsModal').classList.add('show');
    window.closeOverlay = (id) => $(id).classList.remove('show');

    window.openLobby = () => {
      const hash = (location.hash || "").replace("#","").trim().toUpperCase();
      if(hash){
        $('roomCodeInput').value = hash;
        const n = getStoredName(hash);
        if(n) $('playerNameInput').value = n;
      } else {
        const ng = getStoredName(null);
        if(ng && !$('playerNameInput').value) $('playerNameInput').value = ng;
      }
      const err = document.getElementById('nameError');
      if(err) err.style.display = "none";
      $('lobbyModal').classList.add('show');
      setTimeout(()=> $('playerNameInput').focus(), 150);
      updateLobbyButtons();
    }/* =========================================================
       CARTONES (Bingo 90: 3 filas x 9 columnas, 15 n√∫meros)
       ========================================================= */
    function randInt(min, max){ // inclusive
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random() * (i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function generateCard90(){
      // Col ranges por columna:
      // 0: 1-9, 1:10-19, ..., 7:70-79, 8:80-90
      const ranges = [
        [1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]
      ];

      // 1) Elegir 5 columnas por fila (15 huecos)
      const rowCols = [[],[],[]];
      for(let r=0;r<3;r++){
        rowCols[r] = shuffle([0,1,2,3,4,5,6,7,8]).slice(0,5).sort((a,b)=>a-b);
      }

      // 2) Conteo por columna (0..8): cu√°ntas celdas ocupar (1-3)
      const colCount = Array(9).fill(0);
      for(let r=0;r<3;r++){
        rowCols[r].forEach(c => colCount[c]++);
      }

      // Ajuste: evitar columna 0 celdas (se permite en bingo real, pero aqu√≠ lo dejamos)
      // Aun as√≠, aseguramos que no haya 0 columnas con 3 y demasiadas 1: no es cr√≠tico.

      // 3) Elegir n√∫meros √∫nicos por columna
      const colNums = Array.from({length:9}, ()=>[]);
      for(let c=0;c<9;c++){
        const [a,b] = ranges[c];
        const pool = [];
        for(let n=a;n<=b;n++) pool.push(n);
        shuffle(pool);
        colNums[c] = pool.slice(0, colCount[c]).sort((x,y)=>x-y);
      }

      // 4) Montar matriz 3x9 con nulls
      const card = Array.from({length:3}, ()=>Array(9).fill(null));

      // Para cada columna, repartir sus n√∫meros en las filas que la contienen
      for(let c=0;c<9;c++){
        // filas que tienen esta columna
        const rows = [];
        for(let r=0;r<3;r++){
          if(rowCols[r].includes(c)) rows.push(r);
        }
        // Si hay 1 n√∫mero => se coloca en esa fila
        // Si hay 2/3 => respetamos orden ascendente de arriba a abajo
        for(let i=0;i<rows.length;i++){
          const r = rows[i];
          card[r][c] = colNums[c][i] ?? null;
        }
      }

      // 5) Peque√±a correcci√≥n: asegurar 5 n√∫meros por fila (por construcci√≥n deber√≠a)
      // Pero por si acaso, arreglamos huecos moviendo columnas dentro de la misma fila
      for(let r=0;r<3;r++){
        let count = card[r].filter(v=>v!==null).length;
        if(count !== 5){
          // fallback simple (muy raro): regenerar
          return generateCard90();
        }
      }
      return card;
    }

    /* =========================================================
       SALAS (Firebase)
       ========================================================= */
    function makeId(len=6){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789"; // sin confusiones
      let out = "";
      for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    function sanitizeName(str){
      return (str || "").trim().replace(/\s+/g, " ").slice(0,16);
    }

    function getStoredName(roomId){
      const k = roomId ? `bingo_name_${roomId}` : `bingo_name_global`;
      return sanitizeName(localStorage.getItem(k) || "");
    }
    function storeName(roomId, name){
      const k = roomId ? `bingo_name_${roomId}` : `bingo_name_global`;
      localStorage.setItem(k, sanitizeName(name));
    }

    function getName(){
      const val = sanitizeName(($('playerNameInput').value || ""));
      const code = sanitizeName(($('roomCodeInput').value || "")).toUpperCase();
      const stored = getStoredName(code || null);

      const finalName = val || stored;
      if(finalName){
        if(code) storeName(code, finalName);
        else storeName(null, finalName);
        return finalName;
      }
      return "";
    }

    function requireName(){
      const name = getName();
      const err = document.getElementById('nameError');
      if(!name || name.length < 2){
        if(err) err.style.display = "block";
        $('playerNameInput').focus();
        return false;
      }

    // --- Lobby UX: habilitar bot√≥n "Entrar" y auto-join desde QR ---
    let __autoJoinTriggered = false;

    function updateLobbyButtons(){
      const btn = $('btnContinue');
      if(!btn) return;

      const code = (($('roomCodeInput').value || "").trim().toUpperCase());
      const nameOk = (getName() && getName().length >= 2);
      const roomReady = !!code;

      // Si ya tengo roomId (porque ya hice join/create), tambi√©n vale
      const already = !!state.roomId;

      btn.disabled = !(nameOk && (roomReady || already));
      btn.style.opacity = btn.disabled ? 0.5 : 1;
    }

    async function continueFromLobby(){
      try{
        if(!requireName()) { updateLobbyButtons(); return; }

        const code = (($('roomCodeInput').value || "").trim().toUpperCase());
        // Si a√∫n no hemos hecho join/create, hacemos join con el c√≥digo (ideal para QR)
        if(!state.roomId){
          if(!code){
            showClaimBanner("Introduce un c√≥digo de sala o crea una sala.");
            updateLobbyButtons();
            return;
          }
          await joinRoom();
        }
        enterRoomUI();
      }catch(e){
        console.error(e);
        alert("No se pudo entrar a la sala. Revisa el c√≥digo o conexi√≥n.");
      }
    }
      if(err) err.style.display = "none";
      return true;
    }

    async function createRoom(){
      if(!requireName()) return;
      if(!FIREBASE_ENABLED){
        alert("Para multijugador necesitas configurar Firebase en el c√≥digo (firebaseConfig).");
        return;
      }
      await authReady;

      const roomId = makeId(10);

      state.roomId = roomId;
      state.role = "host";
      state.card = null;

      // 1) Registrar host (solo una vez)
      await db.ref(`rooms/${roomId}/hosts`).set({ [state.uid]: true });

      // 2) Crear estado p√∫blico de la partida
      await db.ref(`rooms/${roomId}/state`).set({
        createdAt: Date.now(),
        hostUid: state.uid,
        lineWinner: null,
        bingoWinner: null,
        status: "LISTO",
        called: [],
        currentNumber: null,
        lastJoke: null,
        updatedAt: Date.now()
      });

      // 3) Crear mi cart√≥n (host tambi√©n juega si quiere)
      const card = generateCard90();
      state.card = card;
      await db.ref(`rooms/${roomId}/players/${state.uid}`).set({
        name: getName() + " (Host)",
        card,
        joinedAt: Date.now()
      });

      // UI lobby: mostrar c√≥digo + QR
      $('roomCreated').style.display = "block";
      $('roomCodePill').innerText = roomId;
      $('btnContinue').disabled = false;

      // Prefill hash
      location.hash = roomId;
      $('roomCodeInput').value = roomId;
      updateLobbyButtons();

      // QR
      try{
        $('qrcode').innerHTML = "";
        const url = roomJoinLink(roomId);
        new QRCode(document.getElementById("qrcode"), {
          text: url,
          width: 160,
          height: 160,
          correctLevel: QRCode.CorrectLevel.M
        });
      }catch(e){
        console.log("QR error", e);
      }

      // Conectar listeners
      attachRoomListeners();
      listenMyClaimStatus();
      speak("Sala creada. Comparte el c√≥digo con la familia.");
    }

    function roomJoinLink(roomId){
      // Misma p√°gina + hash
      const base = location.href.split("#")[0];
      return `${base}#${roomId}`;
    }

    async function joinRoom(){
      if(!requireName()) return;
      const code = ($('roomCodeInput').value || "").trim().toUpperCase();
      if(!code) return;

      if(!FIREBASE_ENABLED){
        alert("Para multijugador necesitas configurar Firebase en el c√≥digo (firebaseConfig).");
        return;
      }
      await authReady;

      const snap = await db.ref(`rooms/${code}/state`).get();
      if(!snap.exists()){
        alert("Esa sala no existe üòÖ Revisa el c√≥digo.");
        return;
      }

      state.roomId = code;

      // ¬øsoy host? (sin leer /hosts, que est√° protegido)
      const st = snap.val();
      state.role = (st && st.hostUid === state.uid) ? "host" : "player";

      // Cart√≥n: si existe lo reutiliza; si no, lo crea
      const pRef = db.ref(`rooms/${code}/players/${state.uid}`);
      const pSnap = await pRef.get();
      if(pSnap.exists()){
        const pdata = pSnap.val();
        state.card = pdata.card || null;
      } else {
        const card = generateCard90();
        state.card = card;
        await pRef.set({
          name: getName(),
          card,
          joinedAt: Date.now()
        });
      }

      // UI lobby
      $('roomCreated').style.display = "block";
      $('roomCodePill').innerText = code;
      $('btnContinue').disabled = false;
      location.hash = code;
      $('roomCodeInput').value = code;
      updateLobbyButtons();

      // QR
      try{
        $('qrcode').innerHTML = "";
        const url = roomJoinLink(code);
        new QRCode(document.getElementById("qrcode"), {
          text: url,
          width: 160,
          height: 160,
          correctLevel: QRCode.CorrectLevel.M
        });
      }catch(e){}

      // Conectar listeners
      attachRoomListeners();
      listenMyClaimStatus();
      speak("Dentro. Que empiece el drama.");
    }

    function attachRoomListeners(){
      if(!FIREBASE_ENABLED || !db || !state.roomId) return;

      // Estado de la sala (p√∫blico)
      stateRef().off();
      stateRef().on("value", (snap)=>{
        const st = snap.val();
        if(!st) return;

        state.called = Array.isArray(st.called) ? st.called : [];
        state.currentNumber = st.currentNumber || (state.called.length ? state.called[state.called.length-1] : null);
        state.lastJoke = st.lastJoke || getJoke(state.currentNumber);
        state.roomStatus = st.status || "LISTO";
        state.lineWinner = st.lineWinner || null;
        state.bingoWinner = st.bingoWinner || null;

        // ‚úÖ Si empieza una partida nueva (called vac√≠o y sin ganadores), resetea flags locales
        if((state.called || []).length === 0 && !state.lineWinner && !state.bingoWinner){
          state._autoLineSent = false;
          state._autoBingoSent = false;
          lastSpoken = null;
        }

        updateRoleUI();

        if(state.role === "player" || state.role === "host"){
          if(state.card){
            renderCard(state.card);
            applyCalledToCard(state.called, state.currentNumber);
            maybeAutoClaim();
          }
        }

        updateUIFromShared();

        // Mensaje claro para jugadores cuando termina la partida
        if(state.role === "player" && state.roomStatus === "FIN"){
          showClaimBanner("üèÅ Partida terminada. No hace falta crear otra sala: <strong>espera</strong> a que el host pulse <strong>Nueva partida</strong>.");
        }
      });
      // Reclamaciones (L√çNEA / BINGO) -> visibles en el master
      if(state.role === "host"){
        roomRef(`/claims`).off();
        roomRef(`/claims`).on("child_added", (snap)=>{
          const c = snap.val();
          if(!c) return;

          // Solo atendemos pendientes
          if(c.status && c.status !== "PENDING") return;

          // Si ya hay ganador, marcamos autom√°ticamente
          if(c.type === "L√çNEA" && state.lineWinner){
            roomRef(`/claims/${snap.key}`).update({ status: "ALREADY", resolvedAt: Date.now(), resolvedBy: state.uid }).catch(()=>{});
            return;
          }
          if(c.type === "BINGO" && state.bingoWinner){
            roomRef(`/claims/${snap.key}`).update({ status: "ALREADY", resolvedAt: Date.now(), resolvedBy: state.uid }).catch(()=>{});
            return;
          }

          claimQueue.push(c);
          pumpClaimQueue();
        });
      }

      updateRoleUI();
    }

    function enterRoomUI(){
      $('lobbyModal').classList.remove('show');

      if(FIREBASE_ENABLED && state.roomId){
        // Si soy jugador => mostrar cart√≥n
        if(state.role === "player"){
          renderCard(state.card);
        }
        updateRoleUI();
        requestWakeLock();
      } else {
        // fallback local
        state.role = "local";
        initLocalGame();
      }
    }

    function copyRoomCode(){
      const code = $('roomCodePill').innerText.trim();
      if(!code || code.includes("-")) return;
      navigator.clipboard?.writeText(code);
      speak("C√≥digo copiado.");
    }
    function copyRoomLink(){
      const code = $('roomCodePill').innerText.trim();
      if(!code || code.includes("-")) return;
      const url = roomJoinLink(code);
      navigator.clipboard?.writeText(url);
      speak("Link copiado.");
    }

    /* --- RECONOCIMIENTO DE VOZ (WIFI OIDO T√çA FININ) --- */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.lang = 'es-ES';
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript.toLowerCase();
        console.log("He o√≠do: " + text);

        if (text.includes('l√≠nea') || text.includes('linea')) {
          handleVoiceAction('L√çNEA');
        }
        else if (text.includes('bingo')) {
          handleVoiceAction('BINGO');
        }
        else if (text.includes('continuar') || text.includes('seguir')) {
          // Solo host o local pueden continuar
          if(state.role === "host" || state.role === "local"){
            if(!state.running && (state.called||[]).length > 0) toggleAuto();
          }
        }
      };

      recognition.onend = () => {
        if (isListening) recognition.start();
      };

      recognition.onerror = (e) => {
        console.log("Error voz:", e.error);
        if(e.error === 'not-allowed') {
          alert("Permiso de micr√≥fono denegado.");
          isListening = false;
          els.micBtn.classList.remove('listening');
        }
      };
    } else {
      els.micBtn.style.display = 'none';
      console.log("Navegador sin soporte de voz.");
    }

    window.toggleVoice = () => {
      if (!recognition) return alert("Tu navegador no soporta comandos de voz :(");

      if (isListening) {
        recognition.stop();
        isListening = false;
        els.micBtn.classList.remove('listening');
        speak("O√≠do desactivado.");
      } else {
        try {
          recognition.start();
          isListening = true;
          els.micBtn.classList.add('listening');
          speak("Micro activo. Grita l√≠nea o bingo.");
        } catch (e) { console.error(e); }
      }
    };

    function handleVoiceAction(type) {
      if($('checkModal').classList.contains('show')) return;

      stopGame();
      speak(`¬°Alto! He o√≠do ${type}.`);
      fireConfetti();

      setTimeout(() => {
        if(confirm(`üé§ ¬øHan cantado "${type}"?`)) {
          openCheck();
        } else {
          speak("Seguimos jugando.");
        }
      }, 500);
    }

    /* --- WAKE LOCK (MANTENER PANTALLA ENCENDIDA) --- */
    let wakeLock = null;
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Pantalla bloqueada para no apagarse');

          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock liberado');
            if(document.visibilityState === 'visible') requestWakeLock();
          });
        } catch (err) {
          console.error(`${err.name}, ${err.message}`);
        }
      }
    }
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });

    /* --- SISTEMA DE CONFETI --- */
    function fireConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      let particles = [];
      const colors = ['#d00000', '#ffb703', '#ffffff', '#2d6a4f'];

      for(let i=0; i<300; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          rotation: Math.random() * 360,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4,
          speedY: Math.random() * 5 + 3,
          speedX: Math.random() * 4 - 2,
          speedRot: Math.random() * 4 - 2
        });
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;

        particles.forEach(p => {
          p.y += p.speedY;
          p.x += p.speedX;
          p.rotation += p.speedRot;

          if(p.y < canvas.height) active = true;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
        });

        if(active) requestAnimationFrame(animate);
      }
      animate();
    }

    /* --- INIT --- */
    
    // UI: nombre obligatorio (oculta aviso al escribir)
    document.addEventListener('input', (e)=>{
      if(e.target && (e.target.id === 'playerNameInput' || e.target.id === 'roomCodeInput')){
        const err = document.getElementById('nameError');
        if(e.target.id === 'playerNameInput'){
          if(err && sanitizeName(e.target.value).length >= 2) err.style.display = "none";
        }
        updateLobbyButtons();

        // Si venimos por QR (#SALA) y el usuario acaba de poner nombre, hacemos auto-join
        const hash = (location.hash || "").replace("#","").trim().toUpperCase();
        const nameOk = (getName() && getName().length >= 2);
        if(hash && nameOk && !state.roomId && !__autoJoinTriggered){
          __autoJoinTriggered = true;
          $('roomCodeInput').value = hash;
          continueFromLobby().catch(()=>{ __autoJoinTriggered = false; });
        }
      }
    });

    // Prepara UI local (por si no hay firebase)
    buildMasterGridOnce();
    initLocalGame();
  </script>
</body>
</html>
